generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  RESTAURATEUR
  LIVREUR
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  IN_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum DeliveryStatus {
  WAITING
  ACCEPTED
  PICKED_UP
  ON_ROUTE
  DELIVERED
}

enum DocumentStatus {
  PENDING
  VALID
  EXPIRED
  REJECTED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  role          UserRole
  firstName     String
  lastName      String
  phone         String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  client        Client?
  restaurateur  Restaurateur?
  livreur       Livreur?

  @@map("users")
}

model Client {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  address   String
  city      String
  postalCode String
  
  orders    Order[]
  reviews   Review[]

  @@map("clients")
}

model Restaurateur {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isApproved  Boolean  @default(false)
  approvedAt  DateTime?

  restaurants Restaurant[]
  documents   RestaurateurDocument[]

  @@map("restaurateurs")
}

model Restaurant {
  id              String        @id @default(uuid())
  restaurateurId  String
  restaurateur    Restaurateur  @relation(fields: [restaurateurId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  address         String
  city            String
  postalCode      String
  phone           String
  cuisineType     String
  openingHours    Json
  imageUrl        String?
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  menuItems       MenuItem[]
  orders          Order[]
  reviews         Review[]
  subAccounts     RestaurantSubAccount[]

  @@map("restaurants")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("categories")
}

model MenuItem {
  id            String      @id @default(uuid())
  restaurantId  String
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  price         Float
  category      String
  imageUrl      String?
  isAvailable   Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  orderItems    OrderItem[]

  @@map("menu_items")
}

model Order {
  id            String        @id @default(uuid())
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id])
  restaurantId  String
  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])
  status        OrderStatus   @default(PENDING)
  totalAmount   Float
  deliveryAddress String
  deliveryCity    String
  deliveryPostalCode String
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  orderItems    OrderItem[]
  payment       Payment?
  delivery      Delivery?
  review        Review?

  @@map("orders")
}

model OrderItem {
  id          String    @id @default(uuid())
  orderId     String
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId  String
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id])
  quantity    Int
  price       Float
  
  @@map("order_items")
}

model Payment {
  id              String        @id @default(uuid())
  orderId         String        @unique
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount          Float
  status          PaymentStatus @default(PENDING)
  paymentMethod   String
  transactionId   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("payments")
}

model Livreur {
  id            String    @id @default(uuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicleType   String
  licensePlate  String?
  coverageZones String[]
  isAvailable   Boolean   @default(true)
  isApproved    Boolean   @default(false)
  approvedAt    DateTime?
  averageRating Float     @default(5)
  
  deliveries    Delivery[]
  documents     LivreurDocument[]

  @@map("livreurs")
}

model RestaurateurDocument {
  id             String         @id @default(uuid())
  restaurateurId String
  restaurateur   Restaurateur   @relation(fields: [restaurateurId], references: [id], onDelete: Cascade)
  type           String
  fileUrl        String
  status         DocumentStatus @default(PENDING)
  expiresAt      DateTime?
  verifiedAt     DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@map("restaurateur_documents")
}

model LivreurDocument {
  id         String         @id @default(uuid())
  livreurId  String
  livreur    Livreur        @relation(fields: [livreurId], references: [id], onDelete: Cascade)
  type       String
  fileUrl    String
  status     DocumentStatus @default(PENDING)
  expiresAt  DateTime?
  verifiedAt DateTime?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@map("livreur_documents")
}

model RestaurantSubAccount {
  id           String      @id @default(uuid())
  restaurantId String
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  firstName    String
  lastName     String
  email        String
  passwordHash String
  phone        String?
  role         String      @default("STAFF")
  mustChangePassword Boolean @default(true)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([email])
  @@map("restaurant_sub_accounts")
}

model Delivery {
  id              String          @id @default(uuid())
  orderId         String          @unique
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  livreurId       String?
  livreur         Livreur?        @relation(fields: [livreurId], references: [id])
  status          DeliveryStatus  @default(WAITING)
  pickupAddress   String
  deliveryAddress String
  estimatedTime   Int?
  actualTime      Int?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  completedAt     DateTime?

  @@map("deliveries")
}

model Review {
  id            String      @id @default(uuid())
  orderId       String      @unique
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id])
  restaurantId  String
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id])
  rating        Int
  comment       String?
  createdAt     DateTime    @default(now())

  @@map("reviews")
}

model Notification {
  id          String    @id @default(uuid())
  userId      String
  type        String
  title       String
  message     String
  isRead      Boolean   @default(false)
  sentAt      DateTime  @default(now())

  @@map("notifications")
}
